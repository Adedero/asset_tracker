import{aP as T,aQ as f,aR as E,Q as p}from"./main-DbwiCszp.js";import{f as w}from"./vue-layout.vue_vue_type_script_setup_true_lang-BNFQYZFa.js";class u extends Error{}u.prototype.name="InvalidTokenError";function y(e){return decodeURIComponent(atob(e).replace(/(.)/g,(r,o)=>{let n=o.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function b(e){let r=e.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return y(r)}catch{return atob(r)}}function v(e,r){if(typeof e!="string")throw new u("Invalid token specified: must be a string");r||(r={});const o=r.header===!0?0:1,n=e.split(".")[o];if(typeof n!="string")throw new u(`Invalid token specified: missing part #${o+1}`);let a;try{a=b(n)}catch(t){throw new u(`Invalid token specified: invalid base64 for part #${o+1} (${t.message})`)}try{return JSON.parse(a)}catch(t){throw new u(`Invalid token specified: invalid json for part #${o+1} (${t.message})`)}}async function k(e){var c,i;const{accessToken:r,refreshToken:o}=e;if(!r||!o)return null;const n=await h(r);if(!g(n))return console.log("Access token not expired: forwarding request..."),r;const a=await h(o);if(g(a))return console.log("Refresh token expired!"),null;console.log("Access token expired: getting new access token...");const{data:t,error:s}=await T(`/api/auth/refresh/${o}`,{timeout:f,updateDataOnError:!0,onFetchError:async l=>{if(l.response){const m=await l.response.json();l.data=m}return l}}).get().json();return s!=null&&s.value||!((c=t==null?void 0:t.value)!=null&&c.success)||!((i=t==null?void 0:t.value)!=null&&i.accessToken)?(console.log("Failed to get new access token!"),null):(console.log("New access token retrieved"),t.value.accessToken)}async function h(e){try{const{exp:r}=v(e);return r?r*1e3:null}catch{return null}}function g(e){return e==null||Date.now()>=e}const d=p(),I=async(e,r=!0)=>{const o={};if(r){const{accessToken:s,refreshToken:c}=d.user,i=await k({accessToken:s,refreshToken:c});if(!i){console.log("Failed to get token: redirecting to login"),localStorage.removeItem("user");const l=window.location.pathname;throw window.location.href=`/login?redirect=${l}`,new Error("Unauthenticated")}d.user={...d.user,accessToken:i},o.Authorization=`Bearer ${i}`}const n=new AbortController,t=setTimeout(()=>n.abort(),f);try{const c=await(await fetch(e,{headers:o,signal:n.signal})).json();if(!c.success)throw w(c);return c}catch(s){throw s instanceof Error?s.name==="AbortError"?new Error("The request took too long. Check your internet connection and try again."):new Error(s.message||"Server error"):new Error(String(s))}finally{t&&clearTimeout(t)}},A=E({options:{timeout:f,updateDataOnError:!0,beforeFetch:async e=>{const r=p(),{accessToken:o,refreshToken:n}=r.user,a=await k({accessToken:o,refreshToken:n});if(!a){e.cancel(),console.log("Failed to get token: redirecting to login"),localStorage.removeItem("user");const t=window.location.pathname;return window.location.href=`/login?redirect=${t}`,e}return r.user={...r.user,accessToken:a},e.options.headers={...e.options.headers,Authorization:`Bearer ${a}`},e},onFetchError:async e=>{if(e.response){const r=await e.response.json();e.error=w(r),e.data=null}return e}}});export{I as $,A as u};
